# ───────────────────────────────────────────────────────────────
#  Development Tasks
# ───────────────────────────────────────────────────────────────

[tasks.check]
command = "cargo"
args = ["check", "--workspace"]

[tasks.test]
command = "cargo"
args = ["test", "--workspace"]

[tasks.clippy]
command = "cargo"
args = ["clippy", "--workspace", "--all-targets", "--all-features", "-D", "warnings"]

[tasks.fmt]
command = "cargo"
args = ["fmt"]

# ───────────────────────────────────────────────────────────────
#  Distribution Preparation
# ───────────────────────────────────────────────────────────────

[tasks.prepare-dist]
workspace = false
description = "Initialize distribution directory"
script_runner = "@duckscript"
script = [
  "dist_exists = is_path_exists dist",
  "if not ${dist_exists}",
  "    mkdir dist",
  "end",
]

# ═══════════════════════════════════════════════════════════════
#  CLI Binary Builds
# ═══════════════════════════════════════════════════════════════

[tasks.build-cli-tier]
workspace = false
description = "Build CLI binary for specified CPU tier"
script_runner = "@duckscript"
script = [
  "tier = get_env CPU_TIER",
  "assert ${tier} \"CPU_TIER must be set\"",
  "rust_tier = get_env RUST_CPU_TIER",
  "assert ${rust_tier} \"RUST_CPU_TIER must be set\"",
  "target_triple = get_env TARGET_TRIPLE",
  "assert ${target_triple} \"TARGET_TRIPLE must be set\"",
  "binary_basename = get_env BINARY_BASENAME",
  "assert ${binary_basename} \"BINARY_BASENAME must be set\"",
  "source_file = get_env SOURCE_FILE",
  "assert ${source_file} \"SOURCE_FILE must be set\"",
  "dest_ext = get_env DEST_EXT",
  "",
  "rustflags = concat \"-C target-cpu=\" ${rust_tier}",
  "set_env RUSTFLAGS ${rustflags}",
  "exec --fail-on-error cargo build --release -p reversi_cli --target ${target_triple}",
  "unset_env RUSTFLAGS",
  "",
  "workspace_root = get_env CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY",
  "source = join_path ${workspace_root} reversi_gui src-tauri target ${target_triple} release ${source_file}",
  "exists = is_path_exists ${source}",
  "assert ${exists} \"CLI binary not found after build\"",
  "",
  "dest_name = concat ${binary_basename} \"-\" ${tier} ${dest_ext}",
  "dest = join_path ${workspace_root} dist ${dest_name}",
  "copied = cp ${source} ${dest}",
  "assert ${copied} \"Failed to copy CLI binary\"",
  "echo ✓ Built: ${dest_name}",
]

[tasks.build-cli-base]
workspace = false
description = "Base task for CLI builds"
dependencies = ["prepare-dist"]
run_task = { name = ["build-cli-tier"] }

# ───────────────────────────────────────────────────────────────
#  Windows CLI Builds
# ───────────────────────────────────────────────────────────────

[tasks.build-cli-win-v2]
extend = "build-cli-base"
description = "Build Windows x86_64-v2 CLI"
env = { CPU_TIER = "x86_64-v2", RUST_CPU_TIER = "x86-64-v2", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli.exe", DEST_EXT = ".exe" }

[tasks.build-cli-win-v3]
extend = "build-cli-base"
description = "Build Windows x86_64-v3 CLI"
env = { CPU_TIER = "x86_64-v3", RUST_CPU_TIER = "x86-64-v3", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli.exe", DEST_EXT = ".exe" }

[tasks.build-cli-win-v4]
extend = "build-cli-base"
description = "Build Windows x86_64-v4 CLI"
env = { CPU_TIER = "x86_64-v4", RUST_CPU_TIER = "x86-64-v4", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli.exe", DEST_EXT = ".exe" }

[tasks.build-cli-windows]
workspace = false
description = "Build all Windows CLI binaries"
run_task = { name = ["build-cli-win-v2", "build-cli-win-v3", "build-cli-win-v4"] }

# ───────────────────────────────────────────────────────────────
#  Linux CLI Builds
# ───────────────────────────────────────────────────────────────

[tasks.build-cli-linux-v2]
extend = "build-cli-base"
description = "Build Linux x86_64-v2 CLI"
env = { CPU_TIER = "x86_64-v2", RUST_CPU_TIER = "x86-64-v2", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli", DEST_EXT = "" }

[tasks.build-cli-linux-v3]
extend = "build-cli-base"
description = "Build Linux x86_64-v3 CLI"
env = { CPU_TIER = "x86_64-v3", RUST_CPU_TIER = "x86-64-v3", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli", DEST_EXT = "" }

[tasks.build-cli-linux-v4]
extend = "build-cli-base"
description = "Build Linux x86_64-v4 CLI"
env = { CPU_TIER = "x86_64-v4", RUST_CPU_TIER = "x86-64-v4", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli", DEST_EXT = "" }

[tasks.build-cli-linux]
workspace = false
description = "Build all Linux CLI binaries"
run_task = { name = ["build-cli-linux-v2", "build-cli-linux-v3", "build-cli-linux-v4"] }

# ═══════════════════════════════════════════════════════════════
#  GUI Application Builds
# ═══════════════════════════════════════════════════════════════

[tasks.build-gui-tier]
workspace = false
description = "Build GUI application for specified CPU tier"
cwd = "reversi_gui"
script_runner = "@duckscript"
script = [
  "tier = get_env CPU_TIER",
  "assert ${tier} \"CPU_TIER must be set\"",
  "rust_tier = get_env RUST_CPU_TIER",
  "assert ${rust_tier} \"RUST_CPU_TIER must be set\"",
  "target_triple = get_env TARGET_TRIPLE",
  "assert ${target_triple} \"TARGET_TRIPLE must be set\"",
  "binary_basename = get_env BINARY_BASENAME",
  "assert ${binary_basename} \"BINARY_BASENAME must be set\"",
  "source_file = get_env SOURCE_FILE",
  "assert ${source_file} \"SOURCE_FILE must be set\"",
  "dest_ext = get_env DEST_EXT",
  "",
  "rustflags = concat \"-C target-cpu=\" ${rust_tier}",
  "set_env RUSTFLAGS ${rustflags}",
  "exec --fail-on-error bun run tauri build --target ${target_triple}",
  "unset_env RUSTFLAGS",
  "",
  "workspace_root = get_env CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY",
  "source = join_path ${workspace_root} target ${target_triple} release ${source_file}",
  "exists = is_path_exists ${source}",
  "assert ${exists} \"GUI binary not found after build\"",
  "",
  "dest_name = concat ${binary_basename} \"-\" ${tier} ${dest_ext}",
  "dest = join_path ${workspace_root} dist ${dest_name}",
  "copied = cp ${source} ${dest}",
  "assert ${copied} \"Failed to copy GUI binary\"",
  "echo ✓ Built: ${dest_name}",
]

[tasks.build-gui-base]
workspace = false
description = "Base task for GUI builds"
dependencies = ["prepare-dist"]
run_task = { name = ["build-gui-tier"] }

# ───────────────────────────────────────────────────────────────
#  Windows GUI Builds
# ───────────────────────────────────────────────────────────────

[tasks.build-gui-win-v2]
extend = "build-gui-base"
description = "Build Windows x86_64-v2 GUI"
env = { CPU_TIER = "x86_64-v2", RUST_CPU_TIER = "x86-64-v2", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi.exe", DEST_EXT = ".exe" }

[tasks.build-gui-win-v3]
extend = "build-gui-base"
description = "Build Windows x86_64-v3 GUI"
env = { CPU_TIER = "x86_64-v3", RUST_CPU_TIER = "x86-64-v3", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi.exe", DEST_EXT = ".exe" }

[tasks.build-gui-win-v4]
extend = "build-gui-base"
description = "Build Windows x86_64-v4 GUI"
env = { CPU_TIER = "x86_64-v4", RUST_CPU_TIER = "x86-64-v4", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi.exe", DEST_EXT = ".exe" }

[tasks.build-gui-windows]
workspace = false
description = "Build all Windows GUI binaries"
run_task = { name = ["build-gui-win-v2", "build-gui-win-v3", "build-gui-win-v4"] }

# ───────────────────────────────────────────────────────────────
#  Linux GUI Builds
# ───────────────────────────────────────────────────────────────

[tasks.build-gui-linux-v2]
extend = "build-gui-base"
description = "Build Linux x86_64-v2 GUI"
env = { CPU_TIER = "x86_64-v2", RUST_CPU_TIER = "x86-64-v2", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi", DEST_EXT = "" }

[tasks.build-gui-linux-v3]
extend = "build-gui-base"
description = "Build Linux x86_64-v3 GUI"
env = { CPU_TIER = "x86_64-v3", RUST_CPU_TIER = "x86-64-v3", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi", DEST_EXT = "" }

[tasks.build-gui-linux-v4]
extend = "build-gui-base"
description = "Build Linux x86_64-v4 GUI"
env = { CPU_TIER = "x86_64-v4", RUST_CPU_TIER = "x86-64-v4", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi", DEST_EXT = "" }

[tasks.build-gui-linux]
workspace = false
description = "Build all Linux GUI binaries"
run_task = { name = ["build-gui-linux-v2", "build-gui-linux-v3", "build-gui-linux-v4"] }
