# ───────────────────────────────────────────────────────────────
#  Global Configuration
# ───────────────────────────────────────────────────────────────

[env]
VERSION = "0.13.0"

# ───────────────────────────────────────────────────────────────
#  Development Tasks
# ───────────────────────────────────────────────────────────────

[tasks.check]
command = "cargo"
args = ["check", "--workspace"]

[tasks.test]
command = "cargo"
args = ["test", "--workspace"]

[tasks.clippy]
command = "cargo"
args = ["clippy", "--workspace", "--all-targets", "--all-features", "-D", "warnings"]

[tasks.fmt]
command = "cargo"
args = ["fmt"]

# ───────────────────────────────────────────────────────────────
#  Distribution Preparation
# ───────────────────────────────────────────────────────────────

[tasks.prepare-dist]
workspace = false
description = "Initialize distribution directory"
script_runner = "@duckscript"
script = [
  "dist_exists = is_path_exists dist",
  "if not ${dist_exists}",
  "    mkdir dist",
  "end",
]

# ═══════════════════════════════════════════════════════════════
#  CLI Binary Builds
# ═══════════════════════════════════════════════════════════════

[tasks.build-cli-tier]
workspace = false
description = "Build CLI binary for specified CPU tier"
script_runner = "@duckscript"
script = [
  "tier = get_env CPU_TIER",
  "rust_tier = get_env RUST_CPU_TIER",
  "target_triple = get_env TARGET_TRIPLE",
  "binary_basename = get_env BINARY_BASENAME",
  "source_file = get_env SOURCE_FILE",
  "dest_ext = get_env DEST_EXT",
  "filename_suffix = get_env FILENAME_SUFFIX",
  "suffix_missing = is_empty ${filename_suffix}",
  "if ${suffix_missing}",
  "    prefix = get_env FILENAME_PREFIX",
  "    prefix_missing = is_empty ${prefix}",
  "    sanitized_tier = concat ${tier} \"\"",
  "    if not ${prefix_missing}",
  "        tier_delimiter = get_env FILENAME_TIER_DELIMITER",
  "        tier_delimiter_missing = is_empty ${tier_delimiter}",
  "        if not ${tier_delimiter_missing}",
  "            sanitized_tier = replace ${tier} \"-\" ${tier_delimiter}",
  "        end",
  "        filename_suffix = concat ${prefix} ${sanitized_tier}",
  "    else",
  "        filename_suffix = concat ${sanitized_tier} \"\"",
  "    end",
  "end",
  "",
  "rustflags = concat \"-C target-cpu=\" ${rust_tier}",
  "set_env RUSTFLAGS ${rustflags}",
  "exec --fail-on-error cargo build --release -p reversi_cli --target ${target_triple}",
  "unset_env RUSTFLAGS",
  "",
  "version = get_env VERSION",
  "workspace_root = get_env CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY",
  "source = join_path ${workspace_root} target ${target_triple} release ${source_file}",
  "dest_name = concat ${binary_basename} \"-\" ${version} \"-\" ${filename_suffix} ${dest_ext}",
  "dest = join_path ${workspace_root} dist ${dest_name}",
  "cp ${source} ${dest}",
  "echo ✓ Built: ${dest_name}",
]

[tasks.build-cli-base]
workspace = false
description = "Base task for CLI builds"
dependencies = ["prepare-dist"]
run_task = { name = ["build-cli-tier"] }

# ───────────────────────────────────────────────────────────────
#  Windows CLI Builds
# ───────────────────────────────────────────────────────────────

[tasks.build-cli-windows-v2]
extend = "build-cli-base"
description = "Build Windows x86_64-v2 CLI"
env = { CPU_TIER = "x86_64-v2", RUST_CPU_TIER = "x86-64-v2", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli.exe", DEST_EXT = ".exe", FILENAME_PREFIX = "windows-" }

[tasks.build-cli-windows-v3]
extend = "build-cli-base"
description = "Build Windows x86_64-v3 CLI"
env = { CPU_TIER = "x86_64-v3", RUST_CPU_TIER = "x86-64-v3", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli.exe", DEST_EXT = ".exe", FILENAME_PREFIX = "windows-" }

[tasks.build-cli-windows-v4]
extend = "build-cli-base"
description = "Build Windows x86_64-v4 CLI"
env = { CPU_TIER = "x86_64-v4", RUST_CPU_TIER = "x86-64-v4", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli.exe", DEST_EXT = ".exe", FILENAME_PREFIX = "windows-" }

[tasks.build-cli-windows-native]
extend = "build-cli-base"
description = "Build Windows native CLI"
env = { CPU_TIER = "native", RUST_CPU_TIER = "native", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli.exe", DEST_EXT = ".exe", FILENAME_PREFIX = "windows-" }

[tasks.build-cli-windows]
workspace = false
description = "Build all Windows CLI binaries"
run_task = { name = ["build-cli-windows-v2", "build-cli-windows-v3", "build-cli-windows-v4"] }

# ───────────────────────────────────────────────────────────────
#  Linux CLI Builds
# ───────────────────────────────────────────────────────────────

[tasks.build-cli-linux-v2]
extend = "build-cli-base"
description = "Build Linux x86_64-v2 CLI"
env = { CPU_TIER = "x86_64-v2", RUST_CPU_TIER = "x86-64-v2", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli", DEST_EXT = "", FILENAME_PREFIX = "linux-", FILENAME_TIER_DELIMITER = "_" }

[tasks.build-cli-linux-v3]
extend = "build-cli-base"
description = "Build Linux x86_64-v3 CLI"
env = { CPU_TIER = "x86_64-v3", RUST_CPU_TIER = "x86-64-v3", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli", DEST_EXT = "", FILENAME_PREFIX = "linux-", FILENAME_TIER_DELIMITER = "_" }

[tasks.build-cli-linux-v4]
extend = "build-cli-base"
description = "Build Linux x86_64-v4 CLI"
env = { CPU_TIER = "x86_64-v4", RUST_CPU_TIER = "x86-64-v4", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli", DEST_EXT = "", FILENAME_PREFIX = "linux-", FILENAME_TIER_DELIMITER = "_" }

[tasks.build-cli-linux-native]
extend = "build-cli-base"
description = "Build Linux native CLI"
env = { CPU_TIER = "native", RUST_CPU_TIER = "native", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-cli", SOURCE_FILE = "neural-reversi-cli", DEST_EXT = "", FILENAME_PREFIX = "linux-", FILENAME_TIER_DELIMITER = "_" }

[tasks.build-cli-linux]
workspace = false
description = "Build all Linux CLI binaries"
run_task = { name = ["build-cli-linux-v2", "build-cli-linux-v3", "build-cli-linux-v4"] }

# ═══════════════════════════════════════════════════════════════
#  GUI Application Builds
# ═══════════════════════════════════════════════════════════════

[tasks.build-gui-tier]
workspace = false
description = "Build GUI application for specified CPU tier"
cwd = "reversi_gui"
script_runner = "@duckscript"
script = [
  "tier = get_env CPU_TIER",
  "rust_tier = get_env RUST_CPU_TIER",
  "target_triple = get_env TARGET_TRIPLE",
  "binary_basename = get_env BINARY_BASENAME",
  "source_file = get_env SOURCE_FILE",
  "dest_ext = get_env DEST_EXT",
  "filename_suffix = get_env FILENAME_SUFFIX",
  "suffix_missing = is_empty ${filename_suffix}",
  "if ${suffix_missing}",
  "    prefix = get_env FILENAME_PREFIX",
  "    prefix_missing = is_empty ${prefix}",
  "    sanitized_tier = concat ${tier} \"\"",
  "    if not ${prefix_missing}",
  "        tier_delimiter = get_env FILENAME_TIER_DELIMITER",
  "        tier_delimiter_missing = is_empty ${tier_delimiter}",
  "        if not ${tier_delimiter_missing}",
  "            sanitized_tier = replace ${tier} \"-\" ${tier_delimiter}",
  "        end",
  "        filename_suffix = concat ${prefix} ${sanitized_tier}",
  "    else",
  "        filename_suffix = concat ${sanitized_tier} \"\"",
  "    end",
  "end",
  "",
  "rustflags = concat \"-C target-cpu=\" ${rust_tier}",
  "set_env RUSTFLAGS ${rustflags}",
  "exec --fail-on-error bun run tauri build --target ${target_triple}",
  "unset_env RUSTFLAGS",
  "",
  "version = get_env VERSION",
  "workspace_root = get_env CARGO_MAKE_CURRENT_TASK_INITIAL_MAKEFILE_DIRECTORY",
  "source = join_path ${workspace_root} target ${target_triple} release ${source_file}",
  "dest_name = concat ${binary_basename} \"-\" ${version} \"-\" ${filename_suffix} ${dest_ext}",
  "dest = join_path ${workspace_root} dist ${dest_name}",
  "cp ${source} ${dest}",
  "echo ✓ Built: ${dest_name}",
]

[tasks.build-gui-base]
workspace = false
description = "Base task for GUI builds"
dependencies = ["prepare-dist"]
run_task = { name = ["build-gui-tier"] }

# ───────────────────────────────────────────────────────────────
#  Windows GUI Builds
# ───────────────────────────────────────────────────────────────

[tasks.build-gui-windows-v2]
extend = "build-gui-base"
description = "Build Windows x86_64-v2 GUI"
env = { CPU_TIER = "x86_64-v2", RUST_CPU_TIER = "x86-64-v2", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi.exe", DEST_EXT = ".exe", FILENAME_PREFIX = "windows-" }

[tasks.build-gui-windows-v3]
extend = "build-gui-base"
description = "Build Windows x86_64-v3 GUI"
env = { CPU_TIER = "x86_64-v3", RUST_CPU_TIER = "x86-64-v3", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi.exe", DEST_EXT = ".exe", FILENAME_PREFIX = "windows-" }

[tasks.build-gui-windows-v4]
extend = "build-gui-base"
description = "Build Windows x86_64-v4 GUI"
env = { CPU_TIER = "x86_64-v4", RUST_CPU_TIER = "x86-64-v4", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi.exe", DEST_EXT = ".exe", FILENAME_PREFIX = "windows-" }

[tasks.build-gui-windows-native]
extend = "build-gui-base"
description = "Build Windows native GUI"
env = { CPU_TIER = "native", RUST_CPU_TIER = "native", TARGET_TRIPLE = "x86_64-pc-windows-msvc", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi.exe", DEST_EXT = ".exe", FILENAME_PREFIX = "windows-" }

[tasks.build-gui-windows]
workspace = false
description = "Build all Windows GUI binaries"
run_task = { name = ["build-gui-windows-v2", "build-gui-windows-v3", "build-gui-windows-v4"] }

# ───────────────────────────────────────────────────────────────
#  Linux GUI Builds
# ───────────────────────────────────────────────────────────────

[tasks.build-gui-linux-v2]
extend = "build-gui-base"
description = "Build Linux x86_64-v2 GUI"
env = { CPU_TIER = "x86_64-v2", RUST_CPU_TIER = "x86-64-v2", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi", DEST_EXT = "", FILENAME_PREFIX = "linux-", FILENAME_TIER_DELIMITER = "_" }

[tasks.build-gui-linux-v3]
extend = "build-gui-base"
description = "Build Linux x86_64-v3 GUI"
env = { CPU_TIER = "x86_64-v3", RUST_CPU_TIER = "x86-64-v3", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi", DEST_EXT = "", FILENAME_PREFIX = "linux-", FILENAME_TIER_DELIMITER = "_" }

[tasks.build-gui-linux-v4]
extend = "build-gui-base"
description = "Build Linux x86_64-v4 GUI"
env = { CPU_TIER = "x86_64-v4", RUST_CPU_TIER = "x86-64-v4", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi", DEST_EXT = "", FILENAME_PREFIX = "linux-", FILENAME_TIER_DELIMITER = "_" }

[tasks.build-gui-linux-native]
extend = "build-gui-base"
description = "Build Linux native GUI"
env = { CPU_TIER = "native", RUST_CPU_TIER = "native", TARGET_TRIPLE = "x86_64-unknown-linux-gnu", BINARY_BASENAME = "neural-reversi-gui", SOURCE_FILE = "neural-reversi", DEST_EXT = "", FILENAME_PREFIX = "linux-", FILENAME_TIER_DELIMITER = "_" }

[tasks.build-gui-linux]
workspace = false
description = "Build all Linux GUI binaries"
run_task = { name = ["build-gui-linux-v2", "build-gui-linux-v3", "build-gui-linux-v4"] }

# ═══════════════════════════════════════════════════════════════
#  Native Builds (All Platforms)
# ═══════════════════════════════════════════════════════════════

[tasks.build-native]
workspace = false
description = "Build native CLI and GUI for all platforms"
run_task = { name = ["build-cli-windows-native", "build-cli-linux-native", "build-gui-windows-native", "build-gui-linux-native"] }
